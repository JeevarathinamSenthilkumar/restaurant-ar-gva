<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Markerless AR Restaurant Demo</title>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <style>
      body { margin: 0; overflow: hidden; font-family: Arial; }
      #info {
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.6);
        color: white;
        padding: 8px 12px;
        border-radius: 8px;
        z-index: 100;
      }
    </style>
  </head>

  <body>
    <div id="info">Move your phone to detect a plane, then tap to place the dish</div>

    <a-scene
      vr-mode-ui="enabled: false"
      embedded
      xrweb
      background="color: #ECECEC">

      <!-- Camera for AR -->
      <a-entity camera look-controls></a-entity>

      <!-- Reticle for placement -->
      <a-entity id="reticle"
        geometry="primitive: ring; radiusInner: 0.05; radiusOuter: 0.06"
        material="color: red; shader: flat"
        position="0 0 -1"
        visible="false">
      </a-entity>

      <!-- Dish placeholder -->
      <a-entity id="dish"></a-entity>
    </a-scene>

    <script>
      let scene = document.querySelector('a-scene');
      let reticle = document.getElementById('reticle');
      let dish = document.getElementById('dish');
      let placed = false;

      // Check for WebXR support
      if (navigator.xr) {
        navigator.xr.requestSession('immersive-ar', { requiredFeatures: ['hit-test'] })
        .then(session => {
          scene.renderer.xr.setSession(session);
          const referenceSpace = scene.renderer.xr.getReferenceSpace();
          const viewerSpace = scene.renderer.xr.getReferenceSpace();

          session.requestReferenceSpace('viewer').then(refSpace => {
            session.requestHitTestSource({ space: refSpace }).then(hitTestSource => {

              scene.renderer.setAnimationLoop(() => {
                const frame = scene.renderer.xr.getFrame();
                if (!frame) return;

                const hitTestResults = frame.getHitTestResults(hitTestSource);
                if (hitTestResults.length > 0 && !placed) {
                  const hit = hitTestResults[0];
                  const pose = hit.getPose(referenceSpace);
                  reticle.object3D.position.set(pose.transform.position.x, pose.transform.position.y, pose.transform.position.z);
                  reticle.object3D.visible = true;
                }
              });
            });
          });

          // Tap to place model
          scene.addEventListener('click', () => {
            if (!placed) {
              dish.setAttribute('gltf-model', 'url(croissant.glb)');
              dish.object3D.position.copy(reticle.object3D.position);
              dish.object3D.rotation.set(0, Math.PI, 0);
              dish.object3D.scale.set(0.5, 0.5, 0.5);
              placed = true;
              reticle.object3D.visible = false;
            }
          });

        }).catch(e => console.log("WebXR not supported:", e));
      } else {
        alert("WebXR not supported on this device/browser. Use Chrome on Android or Safari on iOS 16+.");
      }
    </script>
  </body>
</html>
