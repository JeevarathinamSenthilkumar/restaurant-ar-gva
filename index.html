<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Restaurant AR Demo</title>
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: Arial; }
    #info {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      z-index: 100;
      text-align: center;
    }
    #ar-button {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 25px;
      font-size: 18px;
      background: #ff4d00;
      color: white;
      border-radius: 10px;
      text-decoration: none;
      display: none;
      z-index: 100;
    }
  </style>
</head>
<body>
  <div id="info">Move your phone to detect a plane and tap to place the dish</div>
  <a id="ar-button" href="" rel="ar" target="_blank">View Dish in AR</a>

  <a-scene id="scene" vr-mode-ui="enabled: false" embedded xrweb background="color: #ECECEC">
    <a-entity camera look-controls></a-entity>

    <!-- Reticle for placement -->
    <a-entity id="reticle"
      geometry="primitive: ring; radiusInner: 0.05; radiusOuter: 0.06"
      material="color: red; shader: flat"
      position="0 0 -1"
      visible="false">
    </a-entity>

    <!-- Dish placeholder -->
    <a-entity id="dish"></a-entity>
  </a-scene>

  <script>
    // --- Helper to read URL parameters ---
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    const ua = navigator.userAgent;
    const isIOS = /iPhone|iPad|iPod/i.test(ua);
    const arButton = document.getElementById('ar-button');
    const info = document.getElementById('info');
    const scene = document.getElementById('scene');
    const reticle = document.getElementById('reticle');
    const dish = document.getElementById('dish');
    let placed = false;

    // --- Dishes configuration ---
    const dishes = {
      plane_meal: { glb: 'plane_meal.glb', usdz: 'Plane_meal.usdz', scale: 0.001 },
      pizza: { glb: 'pizza.glb', usdz: 'pizza.usdz', scale: 0.001 },
      salmon_tartine: { glb: 'salmon_tartine.glb', usdz: 'Salmon_tartine.usdz', scale: 0.01 },
      raspberries_tart: { glb: 'raspberries_tart.glb', usdz: 'raspberries_tart.usdz', scale: 0.001 },
      vienna_coffee: { glb: 'Vienna_coffee.glb', usdz: 'Vienna_coffee.usdz', scale: 0.001 }
    };

    // Get selected dish from URL parameter
    const dishName = getQueryParam('dish') || 'croissant';
    const dishConfig = dishes[dishName];

    if (!dishConfig) {
      info.innerText = "Dish not found.";
    } else if (isIOS) {
      // iOS Quick Look
      arButton.href = dishConfig.usdz;
      arButton.style.display = "block";
      info.innerText = "Tap the button to view the dish in AR on your table.";
    } else if (navigator.xr) {
      // Android / WebXR markerless AR
      navigator.xr.requestSession('immersive-ar', { requiredFeatures: ['hit-test'] })
      .then(session => {
        scene.renderer.xr.setSession(session);
        const referenceSpace = scene.renderer.xr.getReferenceSpace();

        session.requestReferenceSpace('viewer').then(refSpace => {
          session.requestHitTestSource({ space: refSpace }).then(hitTestSource => {
            scene.renderer.setAnimationLoop(() => {
              const frame = scene.renderer.xr.getFrame();
              if (!frame) return;

              const hitTestResults = frame.getHitTestResults(hitTestSource);
              if (hitTestResults.length > 0 && !placed) {
                const hit = hitTestResults[0];
                const pose = hit.getPose(referenceSpace);
                reticle.object3D.position.set(
                  pose.transform.position.x,
                  pose.transform.position.y,
                  pose.transform.position.z
                );
                reticle.object3D.visible = true;
              }
            });
          });
        });

        // Tap to place GLB model
        scene.addEventListener('click', () => {
          if (!placed) {
            dish.setAttribute('gltf-model', `url(${dishConfig.glb})`);
            dish.object3D.position.copy(reticle.object3D.position);
            dish.object3D.rotation.set(0, Math.PI, 0);

            dish.addEventListener('model-loaded', function onLoad() {
              dish.object3D.scale.set(
                dishConfig.scale,
                dishConfig.scale,
                dishConfig.scale
              );
              dish.removeEventListener('model-loaded', onLoad);
            });

            placed = true;
            reticle.object3D.visible = false;
          }
        });

      }).catch(e => {
        console.log("WebXR not supported:", e);
        info.innerText = "WebXR not supported on this device.";
      });
    } else {
      info.innerText = "AR not supported on this device/browser.";
    }
  </script>
</body>
</html>







